\ Code for true bit bang
\ NO SOC-INIT SO NEED TO CONFIGURE PSTAT AND BB VALUES.
EHON
POFF
\ BITBANG PSTAT PB3-5
\ The gpio registers involved.
040020414h	CONSTANT	GPIOB-ODR
040020441h	CONSTANT	GPIOB-IDR
040020400h	CONSTANT	GPIOB-MODER     \ NEEDED FOR BIT BANG TEST

040020814h	CONSTANT	GPIOC-ODR
040020810h	CONSTANT	GPIOC-IDR
040020800h	CONSTANT	GPIOC-MODER     \ NEEDED FOR BIT BANG TEST

\ This MODER ONLY sets GAIN-S0-S2 and SW1-SW4 high: 055415h
  GPIOC-MODER 055415h SETBITS
  GPIOC-ODR 03C0h SETBITS

\ Bit bang requires 
\ INIT FOR BIT BANG TEST, MODER is 2 bits wide per pin.
\ PB12-14 SETUP FOR CHIP SELECTS
\ PB3 OUT       CLK
\ PB4 IN        MISO
\ PB5 OUT       MOSI

\ THIS ISN'T WORKING.~!
  GPIOB-MODER 015000440h SETBITS

: SETBIT ( 0-based-bit# adrr -- )
	>R              \ STORE @ADDR VALUE
	1h SWAP LSL
	R  @ XOR        \ WHAT IS IT? IT'S NOT AND!
	R>
\	CR .SH
	!
;

: CLRBIT ( 0-based-bit# addr -- )
	>R              \ STORE @ADDR VALUE
	1h SWAP LSL
	R  @ XOR        \ WHAT IS IT? IT'S NOT AND!
	R>
\	CR .SH
	!
;

\ PSTAT SWITCH WORDS, ON THE DAC
: SW1 ( ON | OFF -- )	\ BIT 9
	IF 9 GPIOC-ODR SETBIT ELSE 9 GPIOC-ODR CLRBIT THEN ;

: SW2 ( ON | OFF -- )	\ BIT 8
	IF 8 GPIOC-ODR SETBIT ELSE 8 GPIOC-ODR CLRBIT THEN ;

: SW3 ( ON | OFF -- )	\ BIT 7
	IF 7 GPIOC-ODR SETBIT ELSE 7 GPIOC-ODR CLRBIT THEN ;

: SW4 ( ON | OFF -- )	\ BIT 6
	IF 6 GPIOC-ODR SETBIT ELSE 6 GPIOC-ODR CLRBIT THEN ;

: SWS-ON ON SW1 ON SW2 ON SW3 ON SW4 ;

SWS-ON

: SEEBIT@ ( 1-based-bit# addr -- )
	SWAP \ MAKES STACK ARGS SAME AS SETBIT/CLRBIT
	1 SWAP LSL >R @ R AND R> AND IF ." ON" ELSE ." OFF" THEN ;

: .SCLK CR ." CLK ON PB3 IN BB IS " 3 GPIOB-ODR SEEBIT@	;

: .MISO CR ." MISO ON PB4 IN BB IS " 4 GPIOB-ODR SEEBIT@	;

: .MOSI CR ." MOSI ON PB5 IN BB IS " 5 GPIOB-ODR SEEBIT@	;

\ .BT-CS	PB14	IS LEDGREEN
\ .DAC-CS	PB13	IS LEDRED
\ .ADC-CS	PB12	IS LEDBLUE
\ PSTAT SPI1 CHIP SELECT WORDS.
: .ADC-CS ( -- )	\ PB12
	GPIOB-ODR @ 1000h AND CR ." ADC-CS IS "	IF ." ON" ELSE ." OFF" THEN ;

: .BT-CS ( -- )		\ PB14
	GPIOB-ODR @ 4000h AND CR ." BT-CS IS "	IF ." ON" ELSE ." OFF" THEN ;

: .DAC-CS ( -- )	\ PB13
	GPIOB-ODR @ 2000h AND CR ." DAC-CS IS " IF ." ON" ELSE ." OFF" THEN ;

: .CS	( -- )
	CR	.ADC-CS
	CR	.BT-CS
	CR	.DAC-CS
;

.CS

: ADC-CS ( ON | OFF -- )	\ BIT 12 ON GPIOC
	IF 12d GPIOB-ODR SETBIT ELSE 12d GPIOB-ODR CLRBIT THEN ;

: BT-CS  ( ON | OFF -- )	\ BIT 14
	IF 14d GPIOB-ODR SETBIT ELSE 14d GPIOB-ODR CLRBIT THEN ;

: DAC-CS ( ON | OFF -- )	\ BIT 13
	IF 13d GPIOB-ODR SETBIT ELSE 13d GPIOB-ODR CLRBIT THEN ;

: CS-OFF OFF ADC-CS OFF BT-CS OFF DAC-CS ;

CS-OFF

: .SPI1-BB      CR .SCLK .MISO .MOSI CR ;

.SPI1-BB

: SET-CLK-HI    3 GPIOB-ODR SETBIT ;

\ THIS SHOWS THAT FISH IS NOT SETTING MISO HI WITH A SET-CLK-HI 
\ WHERE THE CUBE CODE DOES.
SET-CLK-HI .SPI1-BB

: SET-CLK-LO    3 GPIOB-ODR CLRBIT ;

SET-CLK-LO .SPI1-BB

.SPI1-BB

\ MOSI (PB5)

: SET-MOSI-HI   5 GPIOB-ODR SETBIT ;

: SET-MOSI-LO   5 GPIOB-ODR CLRBIT ;

SET-MOSI-LO .SPI1-BB

SET-MOSI-HI .SPI1-BB

.MISO

\ DO A SLOW BB TO THE DAC

: BBDAC-LO
\ 1RST 2 BITS OF THE 24, SET TO ZERO
  SWS-ON
  ON DAC-CS
  SET-MOSI-LO
  2 0 DO
    SET-CLK-HI
    1 MS
    SET-CLK-LO
    1 MS
  LOOP
\ SEND 22 BITS ALL HI
  SET-MOSI-HI
  21 0 DO
    SET-CLK-HI
    1 MS
    SET-CLK-LO
    1 MS
  LOOP
  OFF DAC-CS
;

: BBDAC-HI
\ 1RST 2 BITS OF THE 24, SET TO ZERO
  SWS-ON
  ON DAC-CS
  SET-MOSI-LO
  2 0 DO
    SET-CLK-HI
    1 MS
    SET-CLK-LO
    1 MS
  LOOP
\ SEND 22 BITS ALL HI
  SET-MOSI-LO
  21 0 DO
    SET-CLK-HI
    1 MS
    SET-CLK-LO
    1 MS
  LOOP
  OFF DAC-CS
;

: DAC-HI-LO BEGIN BBDAC-HI 700 MS BBDAC-LO 700 MS ?KEY UNTIL ;

: BBDAC-MID
\ 1RST 2 BITS OF THE 24, SET TO ZERO
  SWS-ON
  ON DAC-CS
  SET-MOSI-LO
  2 0 DO
    SET-CLK-HI
    1 MS
    SET-CLK-LO
    1 MS
  LOOP
\ SEND 22 BITS ALL HI
  SET-MOSI-LO
  21 0 DO
    SET-CLK-HI
    1 MS
    I 1 AND IF SET-MOSI-HI ELSE SET-MOSI-LO THEN
    SET-CLK-LO
    1 MS
  LOOP
  OFF DAC-CS
;



\ INIT OF 440h NOT WORKING
(
\ THIS ISN'T WORKING.~!
  GPIOB-MODER 015000440h SETBITS
)
\ SO SET GPIOB MODER 345 AS 101
\ SO CORRECT IN IDE AND THE SEE THE DAC GOTO 0v
\ OR WHATEVER BBDACTEST SENDS~!
PON     \ LEAVING EHON
