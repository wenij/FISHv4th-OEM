\ Code for true bit bang
\ CURRENTLY HAVE TO USE DEBUGGER TO INIT CORRECTLY
\ OR SO i THOUGHT.
\ AND WORDS\MYWORDS IS NOT SHOWING MYWORDS~!
\ YET BB CODE WORKING WITH PB3-5 IN DEFAULT MODE...
\ ?NO SOC-INIT SO NEED TO CONFIGURE PSTAT AND BB VALUES.
EHON
POFF
\ BITBANG PSTAT PB3-5
\ The gpio registers involved AR IN THE GPIO WORDCAT
(
040020414h	CONSTANT	GPIOB-ODR
040020441h	CONSTANT	GPIOB-IDR
040020400h	CONSTANT	GPIOB-MODER
040020814h	CONSTANT	GPIOC-ODR
040020810h	CONSTANT	GPIOC-IDR
040020800h	CONSTANT	GPIOC-MODER
)

\ This MODER ONLY sets GAIN-S0-S2 and SW1-SW4 high: 055415h
\  GPIOC-MODER 055415h SETBITS
\  GPIOC-ODR 03C0h SETBITS

\ Bit bang requires 
\ INIT FOR BIT BANG TEST, MODER is 2 bits wide per pin.
\ PB12-14 SETUP FOR CHIP SELECTS
\ PB3 OUT       CLK
\ PB4 IN        MISO
\ PB5 OUT       MOSI

\ THIS ISN'T WORKING.~!
\  GPIOB-MODER 015000440h SETBITS

: SWS-ON ON SW1 ON SW2 ON SW3 ON SW4 ;

SWS-ON

: .SCLK CR ." CLK ON PB3 IN BB IS " 3 GPIOB-ODR SEEBIT	;

: .MISO CR ." MISO ON PB4 IN BB IS " 4 GPIOB-ODR SEEBIT	;

: .MOSI CR ." MOSI ON PB5 IN BB IS " 5 GPIOB-ODR SEEBIT	;

: .SW1 CR ." SW4 IS " 9 GPIOC-ODR SEEBIT ;

: .SW2 CR ." SW3 IS " 8 GPIOC-ODR SEEBIT ;

: .SW3 CR ." SW2 IS " 7 GPIOC-ODR SEEBIT ;

: .SW4 CR ." SW1 IS " 6 GPIOC-ODR SEEBIT ;

: .SWS CR .SW1 .SW2 .SW3 .SW4 CR ;

.SWS

\ .CS-ADC	PB12	IS LEDBLUE
\ .CS-BT	PB14	IS LEDGREEN
\ .CS-DAC	PB13	IS LEDRED
\ PSTAT SPI1 CHIP SELECT WORDS.
\ : .CS	( -- )
\	CR	.CS-ADC
\	CR	.CS-BT
\	CR	.CS-DAC
\ ;

\ .CS

: CS-OFF OFF CS-ADC OFF CS-BT OFF CS-DAC ;

CS-OFF

\ : .SPI1-BB      CR .SCLK .MISO .MOSI CR ;

\ .SPI1-BB

: SET-CLK-HI    3 GPIOB-ODR SETBIT ;

\ THIS SHOWS THAT FISH IS NOT SETTING MISO HI WITH A SET-CLK-HI 
\ WHERE THE CUBE CODE DOES.
SET-CLK-HI
\ .SPI1-BB

: SET-CLK-LO    3 GPIOB-ODR CLRBIT ;

SET-CLK-LO
\ .SPI1-BB

\ .SPI1-BB

\ MOSI (PB5)

: SET-MOSI-HI   5 GPIOB-ODR SETBIT ;

: SET-MOSI-LO   5 GPIOB-ODR CLRBIT ;

SET-MOSI-LO
\ .SPI1-BB

SET-MOSI-HI
\ .SPI1-BB

\ .MISO

\ DO A SLOW BB TO THE DAC

: BBDAC-LO
\ 1RST 2 BITS OF THE 24, SET TO ZERO
  ON CS-DAC
  SET-MOSI-LO
  2 0 DO
    SET-CLK-HI
    1 MS
    SET-CLK-LO
    1 MS
  LOOP
\ SEND 22 BITS ALL HI
  SET-MOSI-HI
  21 0 DO
    SET-CLK-HI
    1 MS
    SET-CLK-LO
    1 MS
  LOOP
  OFF CS-DAC
;

: BBDAC-HI
\ 1RST 2 BITS OF THE 24, SET TO ZERO
  ON CS-DAC
  SET-MOSI-LO
  2 0 DO
    SET-CLK-HI
  NOOP
    1 MS
    SET-CLK-LO
    1 MS
  LOOP
\ SEND 22 BITS ALL LO
  SET-MOSI-LO
  21 0 DO
    SET-CLK-HI
    1 MS
    SET-CLK-LO
    1 MS
  LOOP
  OFF CS-DAC
;

: BBDAC-HI-LO BEGIN BBDAC-HI 700 MS BBDAC-LO 700 MS ?KEY UNTIL ;

\ not working yet
: BBDAC-MID
\ 1RST 2 BITS OF THE 24, SET TO ZERO
  ON CS-DAC
  SET-MOSI-LO
  2 0 DO
    SET-CLK-HI
    1 MS
    SET-CLK-LO
    1 MS
  LOOP
\ SEND 22 BITS ALL HI
  SET-MOSI-LO
  11 0 DO
    SET-CLK-HI
    1 MS
    SET-CLK-LO
    1 MS
  LOOP
  SET-MOSI-HI
  11 0 DO
    SET-CLK-HI
    1 MS
    SET-CLK-LO
    1 MS
  LOOP
  OFF CS-DAC
;


: DBB ( n -- )
\ BBDAC-HI AND BBDAC-LO WORK WITH SPI INIT~!
\ DO i BEED TO SET THE CLK AND MOSI B4 USE?
\ wILL MOSI CLOCK IN THE BITS IN A LOOPBACK TEST?
\ TB IMPLEMENTED THE DOCON FOR DACWORD !

  ON CS-DAC
  
  24d 0 DO
    CR ." 24 BIT MSB 1RST = " I .D
    SPI1-DAC-BB \ ( -- FLAG )
      DC32 NOOP
    CR ." GOT THIS FLAG FROM SPI1-DAC-BB " DUP .D
    IF SET-MOSI-HI CR ." SET-MOSI-HI "
    ELSE SET-MOSI-LO CR ." SET-MOSI-LO "
    THEN

    SET-CLK-HI
    1 MS
    SET-CLK-LO
  LOOP
  OFF CS-DAC
;    

(
GPIO WORDSET TO TEST:
SPI1-DAC-BB
CS-ADC
CS-BT
CS-DAC
SW1
SW2
SW3
SW4
GS2
GS1
GS0
CLRBITS
SETBITS
ANDBITS
CLRBIT  \ 
SETBIT  \ 
SEEBIT  \ WORKING ON MEMORY, NOT REGISTERS~!
BBDAC-LO
BBDAC-HI
BBDAC-MID
BBDAC-HI-LO
DBB
MAKING DACWORD VISBLE FOR BIT WORD TESTING.
DACWORD
SET-CLK-HI
SET-MOSI-HI
)

(
SHOW BBDAC-HI/LO WORKS WITH THIS SOC-INIT
BBDAC-HI-LO
)

(
THIS NEEDS INTERACTIVE INPUT?
7FFFFF00h DACWORD !
DBB
1000 MS
0 DACWORD !
DBB
)

0 DACWORD !
DACWORD ?
1 DACWORD SETBIT
DACWORD ?
1 DACWORD CLRBIT
DACWORD ?

(
GPIOB-ODR 4000h CLRBITS
\ SEEBIT WORKING ON MEMORY
0 DACWORD !
6 DACWORD SEEBIT
ON DACWORD !
6 DACWORD SEEBIT
\ SEEBIT NOT WORKING ON REGISTERS~!
\ CLRBIT TESTING
ON DACWORD !
2 DACWORD SEEBIT
2 DACWORD CLRBIT
2 DACWORD SEEBIT
\ SETBIT TESTING
OFF DACWORD !
2 DACWORD SEEBIT
2 DACWORD SETBIT
2 DACWORD SEEBIT
6 1 SWAP LSL GPIOC-ODR @
.SH
.SB
XOR
.SH
.SB
GPIOC-ODR !

15d GPIOB-ODR SETBIT
15d GPIOB-ODR CLRBIT
)


\ SO SET GPIOB MODER 345 AS 101
\ SO CORRECT IN IDE AND THE SEE THE DAC GOTO 0v
\ OR WHATEVER BBDACTEST SENDS~!

\ BBDAC-HI-LO
\ DBB
\ DACWORD

PON     \ LEAVING EHON
